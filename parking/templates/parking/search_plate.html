{% extends "shell/base.html" %}

{% block title %}ParkOps / Escanear placa de vehículo{% endblock %}
{% block page_title %}Parking / escanear{% endblock %}

{% block content %}

{% include 'shell/partials/_messages_alert.html' with messages=messages %}
<style>
.scanner-shell {
  position: relative;
  height: 300px;
  background: #000;
  overflow: hidden;
  cursor: pointer;
}

.scanner-shell video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.scanner-mask {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.35);
  pointer-events: none;
  z-index: 2;
}

.scanner-frame {
  position: absolute;
  width: 70%;
  height: 25%;
  top: 38%;
  left: 15%;
  border: 2px solid #00ffcc;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(0,255,204,0.7);
  z-index: 3;
  display: none;
}

.scan-line {
  position: absolute;
  width: 100%;
  height: 2px;
  background: linear-gradient(90deg, transparent, #00ffcc, transparent);
  animation: scan 1.5s linear infinite;
}

.scanner-placeholder {
  position: absolute;
  inset: 0;
  z-index: 4;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  color: #ccc;
  text-align: center;
}

.scanner-icon {
  font-size: 3rem;
  color: #00ffcc;
  animation: pulse 1.8s infinite;
}

.scanner-header {
  position: absolute;
  top: 8px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  z-index: 5;
  color: #00ffcc;
}

.scanner-status {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  padding: 4px 14px;
  border-radius: 20px;
  font-size: 12px;
  color: #fff;
  z-index: 5;
  display: none;
}

.scanner-btn {
  position: absolute;
  bottom: 10px;
  width: 42px;
  height: 42px;
  border-radius: 50%;
  border: none;
  z-index: 6;
  background: rgba(0,0,0,0.9);
  color: white;
}

.scanner-btn.left { left: 10px; }
.scanner-btn.right { right: 10px; background: rgba(220,53,69,0.9); }

@keyframes scan {
  from { top: 0; }
  to { top: 100%; }
}

@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: .6; }
  100% { transform: scale(1); opacity: 1; }
}

</style>

<!-- Card principal -->
<div class="card bg-dark text-light border-0 shadow-lg rounded-4">
    <div class="card-body">

        <!-- Área de cámara -->
        <div class="mb-3" style="height:300px;">
<div class="scanner-shell rounded-4 shadow-lg" id="scannerCard">

  <video id="cameraVideo" autoplay playsinline></video>

  <div class="scanner-mask"></div>

  <div id="plateGuide" class="scanner-frame">
    <div class="scan-line"></div>
  </div>

  <div class="scanner-header">
    <i class="bi bi-car-front-fill me-1"></i>
    <span id="scannerTitle">ParkOps Live Scanner</span>
  </div>

  <div id="cameraPlaceholder" class="scanner-placeholder">
    <div class="scanner-icon">
      <i class="bi bi-camera-video-fill"></i>
    </div>
    <div class="scanner-text">Toca para escanear</div>
    <div class="scanner-subtext">
      Detén el vehículo a 1–4 metros
    </div>
  </div>

  <div id="scannerStatus" class="scanner-status">
    <span id="statusText">Listo</span>
  </div>

  <button id="resetBtn" class="scanner-btn left">
    <i class="bi bi-arrow-clockwise"></i>
  </button>

  <button id="stopBtn" class="scanner-btn right">
    <i class="bi bi-x-lg"></i>
  </button>
</div>

<canvas id="cameraCanvas" class="d-none"></canvas>


        </div>
        <!-- Input -->
        <form method="POST">
            {% csrf_token %}

            <div class="mb-3">
                <label class="form-label small text-muted">
                    Placa del vehículo
                </label>

                <div class="input-group mb-2">
                    <!-- Icono / Cámara -->
                    <span class="input-group-text bg-dark border border-white text-light rounded-start-3">
                        <i class="bi bi-upc-scan text-light opacity-75"></i>
                    </span>

                    <!-- Campo -->
                    <input type="text"
                           name="plate"
                           id="plateInput"
                           value="{{ form.plate.value|default_if_none:'' }}"
                           class="form-control bg-dark border border-white text-light rounded-end-3"
                           placeholder="Escanear o escribir placa..."
                           style="box-shadow:none;"
                           required>
                </div>

                {% if form.plate.help_text %}
                <div class="form-text text-muted mt-1">
                    {{ form.plate.help_text }}
                </div>
                {% endif %}
            </div>

            <!-- Botón -->
            <button type="submit"
                    class="btn btn-success w-100 rounded-pill shadow-sm">
                <i class="bi bi-upc-scan me-1"></i>
                Escanear placa
            </button>
        </form>
    </div>
</div>

{% endblock %}

{% block menu_bottom %}
    {% include 'parking/partials/_parking_menu_bottom.html' %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {

const video = document.getElementById("cameraVideo");
const scannerCard = document.getElementById("scannerCard");
const plateGuide = document.getElementById("plateGuide");
const placeholder = document.getElementById("cameraPlaceholder");
const statusText = document.getElementById("statusText");
const statusBar = document.getElementById("scannerStatus");
const stopBtn = document.getElementById("stopBtn");
const resetBtn = document.getElementById("resetBtn");
const plateInput = document.getElementById("plateInput");
const canvas = document.getElementById("cameraCanvas");

const ctx = canvas.getContext("2d", { willReadFrequently: true });

let stream = null;
let scanning = false;
let stableFrames = 0;
let lastOCR = 0;
let buffer = [];
let lastCandidate = "";

const OCR_DELAY = 2500;
const STABLE_REQUIRED = 8;
const BUFFER_SIZE = 3;

const plateRegex = /\b(P|M|N|C|A|CD)\s?[0-9]{1,3}\s?[A-Z0-9]?\s?[0-9]{2,3}\b/;

// ---------------- UI ----------------
function showStatus(txt) {
  statusText.textContent = txt;
  statusBar.style.display = "block";
}

function showInitial() {
  placeholder.style.display = "flex";
  plateGuide.style.display = "none";
  stopBtn.style.display = "none";
  showStatus("Toca para iniciar escaneo");
}

function showScanning() {
  placeholder.style.display = "none";
  plateGuide.style.display = "block";
  stopBtn.style.display = "block";
  showStatus("Apunta a la placa y detén el vehículo");
}

// ---------------- CAMERA ----------------
async function startCamera() {
  if (stream) return;

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 }},
      audio: false
    });

    video.srcObject = stream;
    await video.play();

    scanning = true;
    stableFrames = 0;
    buffer = [];
    lastCandidate = "";

    showScanning();
    requestAnimationFrame(scanLoop);

  } catch {
    showStatus("❌ Cámara no disponible");
  }
}

function stopCamera() {
  scanning = false;
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  showInitial();
}

// ---------------- FAST DETECTOR ----------------
function detectStable(frame) {
  let edges = 0;
  for (let i = 0; i < frame.data.length; i += 16) {
    const g1 = frame.data[i];
    const g2 = frame.data[i + 4] || g1;
    if (Math.abs(g1 - g2) > 40) edges++;
  }
  return edges > 40;
}

// ---------------- BUFFER ----------------
function pushBuffer(plate) {
  buffer.push(plate);
  if (buffer.length > BUFFER_SIZE) buffer.shift();

  const freq = {};
  buffer.forEach(p => freq[p] = (freq[p] || 0) + 1);

  for (const p in freq) {
    if (freq[p] >= 2) return p;
  }
}

// ---------------- OCR ----------------
async function runOCR(frame, w, h) {
  const temp = document.createElement("canvas");
  temp.width = w;
  temp.height = h;
  temp.getContext("2d").putImageData(frame, 0, 0);

  const result = await Tesseract.recognize(temp, "eng", {
    tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
    psm: 7
  });

  let text = result.data.text
    .toUpperCase()
    .replace(/[^A-Z0-9 ]/g, " ")
    .replace(/\s+/g, " ")
    .trim();

  const match = text.match(plateRegex);
  if (!match) return;

  const plate = match[0].replace(/\s+/g, " ");
  const confirmed = pushBuffer(plate);

  if (confirmed && confirmed !== lastCandidate) {
    lastCandidate = confirmed;
    showCandidate(confirmed);
  }
}

// ---------------- RESULT UI ----------------
function showCandidate(plate) {
  placeholder.innerHTML = `
    <div class="scanner-text text-warning">¿Es esta la placa?</div>
    <div class="fs-3">${plate}</div>
    <div class="mt-2 d-flex gap-2 justify-content-center">
      <button id="okBtn" class="btn btn-success btn-sm">✔ Sí</button>
      <button id="badBtn" class="btn btn-danger btn-sm">✖ No</button>
    </div>
  `;
  placeholder.style.display = "flex";

  document.getElementById("okBtn").onclick = () => {
    plateInput.value = plate;
    stopCamera();
  };

  document.getElementById("badBtn").onclick = () => {
    buffer = [];
    lastCandidate = "";
    placeholder.style.display = "none";
    showStatus("Corrige posición o luz");
  };
}

// ---------------- LOOP ----------------
async function scanLoop() {
  if (!scanning || !video.videoWidth) {
    requestAnimationFrame(scanLoop);
    return;
  }

  const w = video.videoWidth * 0.6;
  const h = video.videoHeight * 0.6;

  canvas.width = w;
  canvas.height = h;
  ctx.drawImage(video, 0, 0, w, h);

  const rx = w * 0.15;
  const ry = h * 0.38;
  const rw = w * 0.7;
  const rh = h * 0.25;

  const frame = ctx.getImageData(rx, ry, rw, rh);
  const stable = detectStable(frame);

  if (stable) stableFrames++;
  else stableFrames = Math.max(0, stableFrames - 1);

  showStatus(`Estabilidad: ${stableFrames}/${STABLE_REQUIRED}`);

  const now = Date.now();
  if (stableFrames >= STABLE_REQUIRED && now - lastOCR > OCR_DELAY) {
    lastOCR = now;
    showStatus("Leyendo placa...");
    await runOCR(frame, rw, rh);
  }

  requestAnimationFrame(scanLoop);
}

// ---------------- EVENTS ----------------
scannerCard.addEventListener("click", startCamera);
stopBtn.addEventListener("click", stopCamera);
resetBtn.addEventListener("click", stopCamera);

// ---------------- INIT ----------------
showInitial();

});
</script>

{% endblock %}
