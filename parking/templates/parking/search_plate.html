{% extends "shell/base.html" %}

{% block title %}ParkOps / Escanear placa de vehículo{% endblock %}
{% block page_title %}Parking / escanear{% endblock %}

{% block content %}

{% include 'shell/partials/_messages_alert.html' with messages=messages %}

<!-- Card principal -->
<div class="card bg-dark text-light border-0 shadow-lg rounded-4">
    <div class="card-body">

        <!-- Área de cámara -->
        <div class="mb-3" style="height:300px;">
<!-- Área cámara -->
<div id="scannerCard" class="bg-dark border border-secondary rounded-4 shadow-lg p-2"
     style="height:300px; position:relative; overflow:hidden; cursor:pointer;">

    <!-- Video -->
    <video id="cameraVideo"
           autoplay
           playsinline
           class="w-100 h-100 d-none rounded-4"
           style="object-fit:cover;"></video>

    <!-- Guía placa -->
    <div id="plateGuide"
         class="position-absolute rounded"
         style="border:2px dashed #0d6efd; width:60%; height:22%; top:39%; left:20%; display:none; pointer-events:none;">
    </div>

    <!-- Placeholder -->
    <div id="cameraPlaceholder"
         class="position-absolute bottom-0 w-100 text-center pb-3">
        <i class="bi bi-camera-video-fill fs-1 text-info"></i>
        <div class="small text-muted">Toca para escanear placa</div>
    </div>

    <!-- Estado -->
    <div id="scannerStatus"
         class="position-absolute bottom-0 w-100 text-center py-1"
         style="background:rgba(0,0,0,.6); display:none;">
        <span class="small text-light" id="statusText">Iniciando cámara...</span>
    </div>

    <!-- Reset -->
    <button id="resetBtn"
            class="btn btn-warning btn-sm position-absolute top-0 end-0 m-2 rounded-circle shadow"
            style="width:42px; height:42px;">
        <i class="bi bi-arrow-clockwise"></i>
    </button>

    <!-- Stop -->
    <button id="stopBtn"
            class="btn btn-danger btn-sm position-absolute bottom-0 end-0 m-2 rounded-circle shadow"
            style="width:42px; height:42px; display:none;">
        <i class="bi bi-x-lg"></i>
    </button>

</div>

</div>

<canvas id="cameraCanvas" class="d-none"></canvas>

        <!-- Input -->
        <form method="POST">
            {% csrf_token %}

            <div class="mb-3">
                <label class="form-label small text-muted">
                    Placa del vehículo
                </label>

                <div class="input-group mb-2">
                    <!-- Icono / Cámara -->
                    <span class="input-group-text bg-dark border border-white text-light rounded-start-3">
                        <i class="bi bi-upc-scan text-light opacity-75"></i>
                    </span>

                    <!-- Campo -->
                    <input type="text"
                           name="plate"
                           id="plateInput"
                           value="{{ form.plate.value|default_if_none:'' }}"
                           class="form-control bg-dark border border-white text-light rounded-end-3"
                           placeholder="Escanear o escribir placa..."
                           style="box-shadow:none;"
                           required>
                </div>

                {% if form.plate.help_text %}
                <div class="form-text text-muted mt-1">
                    {{ form.plate.help_text }}
                </div>
                {% endif %}
            </div>

            <!-- Botón -->
            <button type="submit"
                    class="btn btn-success w-100 rounded-pill shadow-sm">
                <i class="bi bi-upc-scan me-1"></i>
                Escanear placa
            </button>
        </form>
    </div>
</div>

{% endblock %}

{% block menu_bottom %}
    {% include 'parking/partials/_parking_menu_bottom.html' %}
{% endblock %}

{% block extra_js %}
<script>
const plateInput = document.querySelector("input[name='plate']");
const card = document.getElementById("scannerCard");
const video = document.getElementById("cameraVideo");
const placeholder = document.getElementById("cameraPlaceholder");
const plateGuide = document.getElementById("plateGuide");
const stopBtn = document.getElementById("stopBtn");
const resetBtn = document.getElementById("resetBtn");
const statusBox = document.getElementById("scannerStatus");
const statusText = document.getElementById("statusText");
const canvas = document.getElementById("cameraCanvas");
const ctx = canvas.getContext("2d");

let stream = null;
let ocrInterval = null;

// Formatos soportados
const plateRegex = /\b(P\s?\d{1,3}[A-Z]?\-\d{3}|M\s?\d{3}-\d{3}|N\s?\d{2}-\d{3}|CD\s?\d{2}-\d{3}|C\s?\d{3}-\d{3}|A\s?\d{2}-\d{3}|P\s?\d{2}[A-Z]\d{2})\b/;

function setStatus(text, show = true) {
    statusText.innerText = text;
    statusBox.style.display = show ? "block" : "none";
}

// -------------------
// Iniciar cámara
// -------------------
async function startCamera() {
    try {
        setStatus("Iniciando cámara...");
        placeholder.style.display = "none";

        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" }, width:{ideal:1280}, height:{ideal:720} },
            audio: false
        });

        video.srcObject = stream;
        await video.play();

        video.classList.remove("d-none");
        plateGuide.style.display = "block";
        stopBtn.style.display = "block";

        setStatus("Escaneando placa...");
        ocrInterval = setInterval(runOCRFrame, 400);

    } catch (err) {
        console.error(err);
        placeholder.style.display = "block";
        setStatus("No se pudo acceder a la cámara");
    }
}

// -------------------
// Detener cámara
// -------------------
function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }

    clearInterval(ocrInterval);
    video.classList.add("d-none");
    plateGuide.style.display = "none";
    stopBtn.style.display = "none";
    placeholder.style.display = "block";
    setStatus("", false);
}

// -------------------
// Reset total
// -------------------
function resetScanner() {
    plateInput.value = "";
    stopCamera();
    setStatus("Listo para escanear", true);
    setTimeout(() => setStatus("", false), 1500);
}

// -------------------
// OCR Frame
// -------------------
async function runOCRFrame() {
    if (!video.videoWidth) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const x = canvas.width * 0.2;
    const y = canvas.height * 0.4;
    const w = canvas.width * 0.6;
    const h = canvas.height * 0.22;

    const crop = ctx.getImageData(x, y, w, h);
    const temp = document.createElement("canvas");
    temp.width = w;
    temp.height = h;
    temp.getContext("2d").putImageData(crop, 0, 0);

    try {
        const res = await Tesseract.recognize(temp.toDataURL(), "eng", {
            tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 -",
            psm: 6
        });

        const text = res.data.text.toUpperCase().replace(/[^A-Z0-9 -]/g, " ");
        const match = text.match(plateRegex);

        if (match) {
            const plate = match[0].replace(/\s+/g, "");
            plateInput.value = plate;

            navigator.vibrate?.([100, 50, 100]);

            setStatus("Placa detectada: " + plate);
            stopCamera();
        }

    } catch(e) { console.error(e); }
}

// -------------------
// Eventos
// -------------------
card.addEventListener("click", () => {
    if (!stream) startCamera();
});
stopBtn.addEventListener("click", stopCamera);
resetBtn.addEventListener("click", resetScanner);
</script>

{% endblock %}
