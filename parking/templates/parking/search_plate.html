{% extends "shell/base.html" %}

{% block title %}ParkOps / Escanear placa de veh√≠culo{% endblock %}
{% block page_title %}Parking / escanear{% endblock %}

{% block content %}

{% include 'shell/partials/_messages_alert.html' with messages=messages %}
<style>
.scanner-shell {
  position: relative;
  height: 300px;
  background: #000;
  overflow: hidden;
  cursor: pointer;
}

.scanner-shell video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.scanner-mask {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.35);
  pointer-events: none;
  z-index: 2;
}

.scanner-frame {
  position: absolute;
  width: 70%;
  height: 25%;
  top: 38%;
  left: 15%;
  border: 2px solid #00ffcc;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(0,255,204,0.7);
  z-index: 3;
  display: none;
}

.scan-line {
  position: absolute;
  width: 100%;
  height: 2px;
  background: linear-gradient(90deg, transparent, #00ffcc, transparent);
  animation: scan 1.5s linear infinite;
}

.scanner-placeholder {
  position: absolute;
  inset: 0;
  z-index: 4;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  color: #ccc;
  text-align: center;
}

.scanner-icon {
  font-size: 3rem;
  color: #00ffcc;
  animation: pulse 1.8s infinite;
}

.scanner-header {
  position: absolute;
  top: 8px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  z-index: 5;
  color: #00ffcc;
}

.scanner-status {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  padding: 4px 14px;
  border-radius: 20px;
  font-size: 12px;
  color: #fff;
  z-index: 5;
  display: none;
}

.scanner-btn {
  position: absolute;
  bottom: 10px;
  width: 42px;
  height: 42px;
  border-radius: 50%;
  border: none;
  z-index: 6;
  background: rgba(0,0,0,0.9);
  color: white;
}

.scanner-btn.left { left: 10px; }
.scanner-btn.right { right: 10px; background: rgba(220,53,69,0.9); }

@keyframes scan {
  from { top: 0; }
  to { top: 100%; }
}

@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: .6; }
  100% { transform: scale(1); opacity: 1; }
}

</style>

<!-- Card principal -->
<div class="card bg-dark text-light border-0 shadow-lg rounded-4">
    <div class="card-body">

        <!-- √Årea de c√°mara -->
        <div class="mb-3" style="height:300px;">
<div class="scanner-shell rounded-4 shadow-lg" id="scannerCard">

  <video id="cameraVideo" autoplay playsinline></video>

  <div class="scanner-mask"></div>

  <div id="plateGuide" class="scanner-frame">
    <div class="scan-line"></div>
  </div>

  <div class="scanner-header">
    <i class="bi bi-car-front-fill me-1"></i>
    <span id="scannerTitle">ParkOps Live Scanner</span>
  </div>

  <div id="cameraPlaceholder" class="scanner-placeholder">
    <div class="scanner-icon">
      <i class="bi bi-camera-video-fill"></i>
    </div>
    <div class="scanner-text">Toca para escanear</div>
    <div class="scanner-subtext">
      Det√©n el veh√≠culo a 1‚Äì4 metros
    </div>
  </div>

  <div id="scannerStatus" class="scanner-status">
    <span id="statusText">Listo</span>
  </div>

<!-- CAPTURE -->
<button id="captureBtn"
        class="scanner-btn left"
        title="Capturar placa"
        style="background:rgba(25,135,84,0.9);">
  <i class="bi bi-camera-fill"></i>
</button>

<!-- STOP -->
<button id="stopBtn"
        class="scanner-btn right"
        title="Cancelar"
        style="display:none;">
  <i class="bi bi-x-lg"></i>
</button>
</div>

<canvas id="cameraCanvas" class="d-none"></canvas>


        </div>
        <!-- Input -->
        <form method="POST">
            {% csrf_token %}

            <div class="mb-3">
                <label class="form-label small text-muted">
                    Placa del veh√≠culo
                </label>

                <div class="input-group mb-2">
                    <!-- Icono / C√°mara -->
                    <span class="input-group-text bg-dark border border-white text-light rounded-start-3">
                        <i class="bi bi-upc-scan text-light opacity-75"></i>
                    </span>

                    <!-- Campo -->
                    <input type="text"
                           name="plate"
                           id="plateInput"
                           value="{{ form.plate.value|default_if_none:'' }}"
                           class="form-control bg-dark border border-white text-light rounded-end-3"
                           placeholder="Escanear o escribir placa..."
                           style="box-shadow:none;"
                           required>
                </div>

                {% if form.plate.help_text %}
                <div class="form-text text-muted mt-1">
                    {{ form.plate.help_text }}
                </div>
                {% endif %}
            </div>

            <!-- Bot√≥n -->
            <button type="submit"
                    class="btn btn-success w-100 rounded-pill shadow-sm">
                <i class="bi bi-upc-scan me-1"></i>
                Escanear placa
            </button>
        </form>
    </div>
</div>

{% endblock %}

{% block menu_bottom %}
    {% include 'parking/partials/_parking_menu_bottom.html' %}
{% endblock %}

{% block extra_js %}
<script>
/* ==============================
   DOM
============================== */
const video = document.getElementById("cameraVideo");
const scannerCard = document.getElementById("scannerCard");
const plateGuide = document.getElementById("plateGuide");
const placeholder = document.getElementById("cameraPlaceholder");
const statusBar = document.getElementById("scannerStatus");
const statusText = document.getElementById("statusText");

const stopBtn = document.getElementById("stopBtn");
const captureBtn = document.getElementById("captureBtn");

const canvas = document.getElementById("cameraCanvas");
const ctx = canvas.getContext("2d");

/* ==============================
   STATE
============================== */
let stream = null;
let scanning = false;
let lastFrame = null;

let logsVisible = false;
let tapCount = 0;
let tapTimer = null;

/* ==============================
   LOG PANEL
============================== */
const logPanel = document.createElement("div");
logPanel.style = `
  position:absolute;
  inset:10px;
  background:rgba(0,0,0,0.85);
  color:#0f0;
  font-family:monospace;
  font-size:11px;
  padding:10px;
  overflow:auto;
  border-radius:10px;
  display:none;
  z-index:99;
`;
scannerCard.appendChild(logPanel);

function log(msg) {
  const line = document.createElement("div");
  line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  logPanel.appendChild(line);
  logPanel.scrollTop = logPanel.scrollHeight;
}

/* ==============================
   DOUBLE TAP TOGGLE LOGS
============================== */
scannerCard.addEventListener("click", () => {
  tapCount++;
  clearTimeout(tapTimer);

  tapTimer = setTimeout(() => {
    if (tapCount >= 2) {
      logsVisible = !logsVisible;
      logPanel.style.display = logsVisible ? "block" : "none";
      log("LOG PANEL TOGGLED");
    }
    tapCount = 0;
  }, 300);
});

/* ==============================
   UI
============================== */
function showStatus(text) {
  statusBar.style.display = "block";
  statusText.textContent = text;
}

function showInitial() {
  placeholder.style.display = "flex";
  video.classList.add("d-none");
  plateGuide.style.display = "none";
  stopBtn.style.display = "none";
  captureBtn.style.display = "none";
  showStatus("Toca para iniciar c√°mara");
}

function showScanning() {
  placeholder.style.display = "none";
  video.classList.remove("d-none");
  plateGuide.style.display = "block";
  stopBtn.style.display = "block";
  captureBtn.style.display = "block";
  showStatus("Alinea la placa y presiona CAPTURAR");
}

/* ==============================
   CAMERA
============================== */
async function startCamera() {
  try {
    log("Requesting camera...");
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: "environment",
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    });

    video.srcObject = stream;
    await video.play();

    scanning = true;
    showScanning();
    scanLoop();
    log("Camera started");
  } catch (err) {
    showStatus("‚ùå C√°mara no disponible");
    log("Camera error: " + err.message);
  }
}

function stopStream() {
  if (!stream) return;
  stream.getTracks().forEach(t => t.stop());
  stream = null;
  log("Camera stopped");
}

/* ==============================
   SCAN LOOP (NO OCR)
============================== */
function scanLoop() {
  if (!scanning) return;

  const scale = 0.5;
  const w = video.videoWidth * scale;
  const h = video.videoHeight * scale;

  if (!w || !h) {
    requestAnimationFrame(scanLoop);
    return;
  }

  canvas.width = w;
  canvas.height = h;
  ctx.drawImage(video, 0, 0, w, h);

  // Regi√≥n central (placa)
  const rx = w * 0.15;
  const ry = h * 0.4;
  const rw = w * 0.7;
  const rh = h * 0.22;

  lastFrame = ctx.getImageData(rx, ry, rw, rh);

  requestAnimationFrame(scanLoop);
}

/* ==============================
   PREPROCESS (LUZ D√çA + PLACAS BLANCAS)
============================== */
function preprocess(img) {
  const d = img.data;

  for (let i = 0; i < d.length; i += 4) {
    let r = d[i];
    let g = d[i + 1];
    let b = d[i + 2];

    // Grayscale
    let gray = (r * 0.3 + g * 0.59 + b * 0.11);

    // Boost contraste
    gray = (gray - 128) * 1.4 + 128;

    // Threshold din√°mico
    const val = gray > 140 ? 255 : 0;

    d[i] = d[i + 1] = d[i + 2] = val;
  }

  return img;
}

/* ==============================
   OCR
============================== */
async function runOCR(frame, w, h) {
  const temp = document.createElement("canvas");
  temp.width = w;
  temp.height = h;
  temp.getContext("2d").putImageData(frame, 0, 0);

  const dataUrl = temp.toDataURL("image/png");

  try {
    log("OCR started");

    const result = await Tesseract.recognize(dataUrl, "eng", {
      tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-",
      logger: m => log(`OCR ${Math.round(m.progress * 100)}%`)
    });

    let text = result.data.text
      .replace(/[^A-Z0-9-]/g, "")
      .trim();

    if (text.length >= 4) {
      showStatus("‚úÖ Detectado: " + text);
      log("PLATE FOUND: " + text);
      beep();
      showConfirm(text);
    } else {
      showStatus("‚ö†Ô∏è No se detect√≥ placa clara");
      log("NO PLATE FOUND");
    }
  } catch (err) {
    log("OCR ERROR: " + err.message);
    showStatus("‚ùå Error OCR");
  }
}

/* ==============================
   CONFIRM UI
============================== */
function showConfirm(plate) {
  const box = document.createElement("div");
  box.style = `
    position:absolute;
    bottom:60px;
    left:50%;
    transform:translateX(-50%);
    background:#000;
    padding:12px 20px;
    border-radius:12px;
    display:flex;
    gap:10px;
    z-index:50;
  `;

  box.innerHTML = `
    <button id="okBtn" style="background:#198754;color:white;border:none;padding:6px 14px;border-radius:8px;">‚úî Confirmar</button>
    <button id="badBtn" style="background:#dc3545;color:white;border:none;padding:6px 14px;border-radius:8px;">‚úñ Reintentar</button>
  `;

  scannerCard.appendChild(box);

  document.getElementById("okBtn").onclick = () => {
    log("CONFIRMED: " + plate);
    showStatus("üöó Registrado: " + plate);
    box.remove();
  };

  document.getElementById("badBtn").onclick = () => {
    log("REJECTED: " + plate);
    showStatus("Reintenta captura");
    box.remove();
  };
}

/* ==============================
   SOUND
============================== */
function beep() {
  const ctxAudio = new AudioContext();
  const osc = ctxAudio.createOscillator();
  const gain = ctxAudio.createGain();

  osc.connect(gain);
  gain.connect(ctxAudio.destination);

  osc.frequency.value = 1200;
  gain.gain.value = 0.05;

  osc.start();
  osc.stop(ctxAudio.currentTime + 0.15);
}

/* ==============================
   EVENTS
============================== */
scannerCard.addEventListener("click", () => {
  if (!scanning) startCamera();
});

stopBtn.addEventListener("click", e => {
  e.stopPropagation();
  scanning = false;
  stopStream();
  showInitial();
});

captureBtn.addEventListener("click", async e => {
  e.stopPropagation();

  if (!lastFrame) {
    showStatus("üì∑ No hay imagen a√∫n");
    return;
  }

  showStatus("üîç Analizando placa...");
  log("CAPTURE pressed");

  const frame = new ImageData(
    new Uint8ClampedArray(lastFrame.data),
    lastFrame.width,
    lastFrame.height
  );

  preprocess(frame);
  await runOCR(frame, frame.width, frame.height);
});

/* ==============================
   INIT
============================== */
showInitial();
log("Scanner ready");
</script>

{% endblock %}
