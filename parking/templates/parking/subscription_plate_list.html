{% extends "shell/base.html" %}

{% block title %}ParkOps / Entradas del día{% endblock %}
{% block page_title %}Parking Suscripciones{% endblock %}

{% block content %}

{% include 'shell/partials/_messages_alert.html' with messages=messages %}

<!-- Buscador + Chips de estado -->
<div class="card bg-dark text-light border-0 shadow-lg rounded-4 mb-3">
    <div class="card-body">

        <!-- Buscador -->
        <div class="input-group mb-2">

            <span class="input-group-text bg-dark border border-secondary text-light rounded-start-3">
                <i class="bi bi-search text-light opacity-75"></i>
            </span>

            <input type="text"
                id="plateSearch"
                class="form-control bg-dark border border-secondary text-light rounded-end-3"
                placeholder="Buscar suscripción..."
                style="box-shadow:none;"
            >

        </div>

        <!-- Chips -->
        <div class="d-flex gap-2">
            <button class="btn btn-sm rounded-pill btn-success" data-filter="all">
                Todos
            </button>
            <button class="btn btn-sm rounded-pill btn-dark" data-filter="active">
                Activos
            </button>
            <button class="btn btn-sm rounded-pill btn-dark" data-filter="inactive">
                Inactivos
            </button>
        </div>
    </div>
</div>

<!-- Lista de suscripciones -->
<div class="row g-3">

    {% for plate in plates %}
        <div class="col-12 col-lg-4 col-md-6">
            <div
                class="card bg-dark text-light border-0 shadow-lg rounded-4 monthly-card"
                data-plate="{{ plate.plate|lower }}"
                data-state="{% if plate.active %}active{% else %}inactive{% endif %}"
                data-type="{{ plate.billing_type|lower }}"
            >

                <!-- Zona táctil SOLO para desplegar -->
                <div class="card-body py-2 px-3"
                    role="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#details-{{ plate.id }}"
                    aria-expanded="false"
                >

                    <!-- Fila principal -->
                    <div class="d-flex align-items-center justify-content-between">

                        <!-- Izquierda -->
                        <div class="d-flex align-items-center">
                            <div class="bg-info bg-opacity-10 rounded-circle p-2 me-2">
                                <i class="bi 
                                    {% if plate.billing_type == 'MONTHLY' %}bi-calendar-check
                                    {% elif plate.billing_type == 'DAILY' %}bi-sun
                                    {% else %}bi-clock
                                    {% endif %}
                                    text-info">
                                </i>
                            </div>

                            <div>
                                <div class="d-flex align-items-center">
                                    <strong class="me-2">{{ plate.plate }}</strong>

                                    <span class="rounded-circle d-inline-block"
                                        style="width:8px; height:8px;
                                        background-color: {% if plate.active %}#22c55e{% else %}#6b7280{% endif %};">
                                    </span>
                                </div>

                                <small class="text-muted">
                                    {{ plate.owner_name }}
                                </small>
                            </div>
                        </div>

                        <!-- Derecha: TIPO + MONTO -->
                        <div class="text-end">
                            <small class="text-muted">
                                {% if plate.billing_type == 'MONTHLY' %}
                                    Mensualidad
                                {% elif plate.billing_type == 'DAILY' %}
                                    Tarifa diaria
                                {% else %}
                                    Tarifa por hora
                                {% endif %}
                            </small>

                            <div class="fw-bold fs-5 text-success">
                                ${{ plate.amount|floatformat:2 }}
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Contenido desplegable -->
                <div class="collapse" id="details-{{ plate.id }}">
                    <div class="px-3 pb-3 pt-2 border-top">

                        <div class="d-flex justify-content-between small flex-wrap mb-2">

                            <div class="me-3">
                                <span class="text-muted">Propietario</span><br>
                                <strong>
                                    {{ plate.owner_name }}
                                </strong>
                            </div>

                            <div class="me-3">
                                <span class="text-muted">Estado</span><br>
                                <strong>
                                    {% if plate.active %}Activo{% else %}Inactivo{% endif %}
                                </strong>
                            </div>

                            <div class="me-3">
                                <span class="text-muted">Tipo de cobro</span><br>
                                <strong>
                                    {% if plate.billing_type == 'MONTHLY' %}
                                        Mensual
                                    {% elif plate.billing_type == 'DAILY' %}
                                        Diario
                                    {% else %}
                                        Por hora
                                    {% endif %}
                                </strong>
                            </div>

                            <div>
                                <span class="text-muted">Registrado</span><br>
                                <strong>
                                    {{ plate.created_at|date:"d/m/Y" }}
                                </strong>
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-flex gap-2">
                            <a
                                href="{% url 'subscription_edit' plate.id %}"
                                class="btn btn-sm btn-primary rounded-pill px-3 w-50"
                            >
                                <i class="bi bi-pencil-square me-1"></i>
                                Editar
                            </a>

                            <form
                                method="POST"
                                action="{% url 'toggle_subscription_active' plate.id %}"
                                class="d-inline w-50"
                            >
                                {% csrf_token %}

                                <button
                                    type="submit"
                                    class="btn btn-sm rounded-pill px-3 w-100
                                    {% if plate.active %}btn-danger{% else %}btn-success{% endif %}"
                                >
                                    <i class="bi {% if plate.active %}bi-pause-circle{% else %}bi-play-circle{% endif %} me-1"></i>

                                    {% if plate.active %}
                                        Desactivar
                                    {% else %}
                                        Activar
                                    {% endif %}
                                </button>
                            </form>
                        </div>

                    </div>
                </div>

            </div>
        </div>

    {% empty %}
        <div class="col-12">
            <div class="card bg-dark text-light border-0 shadow-sm rounded-4">
                <div class="card-body text-center text-muted">
                    No hay suscripciones registradas
                </div>
            </div>
        </div>
    {% endfor %}

    <!-- Estado vacío dinámico (JS) -->
    <div class="col-12 d-none" id="noResults">
        <div class="card bg-dark text-light border-0 shadow-sm rounded-4">
            <div class="card-body text-center text-muted py-4">
                <i class="bi bi-search fs-3 d-block mb-2"></i>
                No se encontraron suscripciones con ese criterio
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block menu_bottom %}
    {% include 'parking/partials/_parking_menu_month_bottom.html' %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {

    const searchInput = document.getElementById("plateSearch");
    const filterButtons = document.querySelectorAll("[data-filter]");
    const cards = document.querySelectorAll(".monthly-card");
    const noResults = document.getElementById("noResults");

    let currentFilter = "all";

    function normalize(text) {
        return text
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");
    }

    function filterCards() {
        const query = normalize(searchInput.value.trim());
        let visibleCount = 0;

        cards.forEach(card => {
            const plate = normalize(card.dataset.plate || "");
            const state = card.dataset.state || "active";

            // Busca propietario dentro del card
            const ownerEl = card.querySelector("small.text-muted");
            const owner = normalize(ownerEl ? ownerEl.textContent : "");

            const matchesText =
                plate.includes(query) ||
                owner.includes(query);

            const matchesState =
                currentFilter === "all" ||
                state === currentFilter;

            if (matchesText && matchesState) {
                card.closest(".col-12").classList.remove("d-none");
                visibleCount++;
            } else {
                card.closest(".col-12").classList.add("d-none");
            }
        });

        if (noResults) {
            if (visibleCount === 0) {
                noResults.classList.remove("d-none");
            } else {
                noResults.classList.add("d-none");
            }
        }
    }

    // Buscar en vivo
    searchInput.addEventListener("input", filterCards);

    // Chips de estado
    filterButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            filterButtons.forEach(b => {
                b.classList.remove("btn-success");
                b.classList.add("btn-dark");
            });

            btn.classList.remove("btn-dark");
            btn.classList.add("btn-success");

            currentFilter = btn.dataset.filter;
            filterCards();
        });
    });

});
</script>
{% endblock %}