{% extends "shell/base.html" %}

{% block title %}ParkOps / Escanear placa de vehículo{% endblock %}
{% block page_title %}Parking / escanear{% endblock %}

{% block content %}

{% include 'shell/partials/_messages_alert.html' with messages=messages %}

<!-- Card principal -->
<div class="card bg-dark text-light border-0 shadow-lg rounded-4">
    <div class="card-body">

        <!-- Área de cámara -->
        <div class="mb-3" style="height:300px;">
            <div id="cameraBox" class="bg-black-custom border border-secondary rounded-4
                       d-flex justify-content-center align-items-center
                       position-relative overflow-hidden"
                 style="cursor:pointer; height:100%; width:100%;">

                <!-- Placeholder inicial -->
                <div id="cameraPlaceholder" class="position-absolute bottom-0 mb-3 text-center w-100">
                    <i class="bi bi-camera-video-fill fs-1 text-info mb-1"></i>
                    <div class="small text-muted">Toca aquí para activar la cámara</div>
                </div>

                <!-- Video -->
                <video id="cameraVideo"
                       autoplay
                       playsinline
                       class="w-100 h-100 d-none"
                       style="object-fit: cover;">
                </video>

                <!-- Overlay de guía para placa -->
                <div id="plateGuide"
                     class="position-absolute"
                     style="
                        border: 2px dashed #0d6efd; 
                        width: 60%; 
                        height: 20%; 
                        top: 40%; 
                        left: 20%; 
                        pointer-events: none;
                        display:none;
                     ">
                </div>

                <!-- Botones -->
                <button id="captureBtn"
                        class="btn btn-success position-absolute bottom-0 start-0 m-2 rounded-circle shadow"
                        style="width:56px; height:56px; display:none;">
                    <i class="bi bi-camera-fill fs-4"></i>
                </button>

                <button id="stopBtn"
                        class="btn btn-danger position-absolute bottom-0 end-0 m-2 rounded-circle shadow"
                        style="width:56px; height:56px; display:none;">
                    <i class="bi bi-x-circle-fill fs-4"></i>
                </button>

                <!-- Botón Reset -->
                <button id="resetBtn"
                        class="btn btn-warning position-absolute top-0 end-0 m-2 rounded-circle shadow"
                        style="width:56px; height:56px; display:none;">
                    <i class="bi bi-arrow-clockwise fs-4"></i>
                </button>
            </div>
        </div>

        <!-- Canvas oculto para procesar frames -->
        <canvas id="cameraCanvas" class="d-none"></canvas>

        <!-- Input -->
        <form method="POST">
            {% csrf_token %}

            <div class="mb-3">
                <label class="form-label small text-muted">
                    Placa del vehículo
                </label>

                <div class="input-group mb-2">
                    <!-- Icono / Cámara -->
                    <span class="input-group-text bg-dark border border-white text-light rounded-start-3">
                        <i class="bi bi-upc-scan text-light opacity-75"></i>
                    </span>

                    <!-- Campo -->
                    <input type="text"
                           name="plate"
                           id="plateInput"
                           value="{{ form.plate.value|default_if_none:'' }}"
                           class="form-control bg-dark border border-white text-light rounded-end-3"
                           placeholder="Escanear o escribir placa..."
                           style="box-shadow:none;"
                           required>
                </div>

                {% if form.plate.help_text %}
                <div class="form-text text-muted mt-1">
                    {{ form.plate.help_text }}
                </div>
                {% endif %}
            </div>

            <!-- Botón -->
            <button type="submit"
                    class="btn btn-success w-100 rounded-pill shadow-sm">
                <i class="bi bi-upc-scan me-1"></i>
                Escanear placa
            </button>
        </form>
    </div>
</div>

{% endblock %}

{% block menu_bottom %}
    {% include 'parking/partials/_parking_menu_bottom.html' %}
{% endblock %}

{% block extra_js %}
<script>
const plateInput = document.querySelector("input[name='plate']");
const cameraBox = document.getElementById("cameraBox");
const placeholder = document.getElementById("cameraPlaceholder");
const video = document.getElementById("cameraVideo");
const canvas = document.getElementById("cameraCanvas");
const ctx = canvas.getContext("2d");
const captureBtn = document.getElementById("captureBtn");
const stopBtn = document.getElementById("stopBtn");
const resetBtn = document.getElementById("resetBtn");
const plateGuide = document.getElementById("plateGuide");

let stream = null;
let ocrInterval = null;

// Regex para placas tipo "P111 111"
const plateRegex = /\b[A-Z]{1}[0-9]{3}\s?[0-9]{3}\b/;

// -----------------------------
// Inicia la cámara
// -----------------------------
async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" }, width: { ideal:1280 }, height:{ ideal:720 } },
            audio: false
        });
        video.srcObject = stream;
        await video.play();

        // Mostrar elementos
        video.classList.remove("d-none");
        placeholder.style.display = "none";
        captureBtn.style.display = "block";
        stopBtn.style.display = "block";
        plateGuide.style.display = "block";
        resetBtn.style.display = "none";

        // OCR en tiempo real
        ocrInterval = setInterval(runOCRFrame, 500);

    } catch (err) {
        console.error(err);
        placeholder.innerHTML = "❌ Cámara no disponible";
    }
}

// -----------------------------
// Detener cámara
// -----------------------------
function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    video.classList.add("d-none");
    placeholder.style.display = "block";
    captureBtn.style.display = "none";
    stopBtn.style.display = "none";
    plateGuide.style.display = "none";
    clearInterval(ocrInterval);
}

// -----------------------------
// Reset para volver al inicio
// -----------------------------
function resetCamera() {
    plateInput.value = "";
    resetBtn.style.display = "none";

    // Ocultar mensaje de resultado
    const resultDiv = document.getElementById("detectionResult");
    if (resultDiv) resultDiv.remove();

    // Mostrar placeholder
    placeholder.style.display = "block";

    // Ocultar video y guía
    video.style.display = "none";
    plateGuide.style.display = "none";
    captureBtn.style.display = "none";
    stopBtn.style.display = "none";

    stream = null;
}

// -----------------------------
// OCR frame por frame
// -----------------------------
async function runOCRFrame() {
    if (!video.videoWidth || !video.videoHeight) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Recortar rectángulo guía
    const rectX = canvas.width * 0.2;
    const rectY = canvas.height * 0.4;
    const rectW = canvas.width * 0.6;
    const rectH = canvas.height * 0.2;

    const imageData = ctx.getImageData(rectX, rectY, rectW, rectH);
    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = rectW;
    tempCanvas.height = rectH;
    tempCanvas.getContext("2d").putImageData(imageData, 0, 0);

    const imageDataUrl = tempCanvas.toDataURL("image/png");

    try {
        const result = await Tesseract.recognize(
            imageDataUrl,
            "eng",
            { tessedit_char_whitelist:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ", psm:6 }
        );

        let text = result.data.text.toUpperCase().replace(/[^A-Z0-9 ]/g," ").replace(/\s+/g," ");
        const match = text.match(plateRegex);

        if (match) {
            const plate = match[0].replace(" ","");
            plateInput.value = plate;

            if (navigator.vibrate) navigator.vibrate([100,50,100]);

            // DETENER CÁMARA
            stopCamera();

            // Mostrar mensaje de éxito
            let resultDiv = document.getElementById("detectionResult");
            if (!resultDiv) {
                resultDiv = document.createElement("div");
                resultDiv.id = "detectionResult";
                resultDiv.className = "d-flex flex-column justify-content-center align-items-center h-100 text-center";
                cameraBox.appendChild(resultDiv);
            }
            resultDiv.innerHTML = `
                <i class="bi bi-check-circle-fill fs-1 text-success mb-2"></i>
                <div class="fw-bold text-success">Placa detectada</div>
                <div class="small text-light mt-1">${plate}</div>
            `;

            // Mostrar botón reset
            resetBtn.style.display = "block";
        }

    } catch (err) {
        console.error(err);
    }
}

// -----------------------------
// Eventos
// -----------------------------
cameraBox.addEventListener("click", () => {
    if (!stream) startCamera();
});
stopBtn.addEventListener("click", stopCamera);
resetBtn.addEventListener("click", resetCamera);
</script>


{% endblock %}
