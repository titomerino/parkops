{% extends "shell/base.html" %}

{% block title %}ParkOps / Escanear placa de vehículo{% endblock %}
{% block page_title %}Parking / escanear{% endblock %}

{% block content %}

{% include 'shell/partials/_messages_alert.html' with messages=messages %}
<style>
    /* ==== SCANNER SHELL ==== */
.scanner-shell {
  background: radial-gradient(circle at center, #111 0%, #000 70%);
}

/* Encabezado */
.scanner-header {
  position: absolute;
  top: 8px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  color: #0d6efd;
  z-index: 5;
}

/* Placeholder */
.scanner-placeholder {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #ccc;
  z-index: 4;
  text-align: center;
}

.scanner-icon {
  font-size: 3rem;
  color: #0d6efd;
  animation: pulse 1.8s infinite;
}

.scanner-text {
  font-weight: 600;
  margin-top: 8px;
}

.scanner-subtext {
  font-size: 12px;
  opacity: 0.7;
}

/* Marco */
.scanner-frame {
  position: absolute;
  width: 60%;
  height: 22%;
  top: 39%;
  left: 20%;
  border: 2px solid #0d6efd;
  border-radius: 10px;
  box-shadow: 0 0 20px rgba(13,110,253,0.5);
  display: none;
  z-index: 3;
  overflow: hidden;
}

/* Línea animada */
.scan-line {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(90deg, transparent, #00ffcc, transparent);
  animation: scan 1.5s linear infinite;
}

/* Máscara */
.scanner-mask {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.35);
  z-index: 2;
  pointer-events: none;
}

/* Estado inferior */
.scanner-status {
  position: absolute;
  bottom: 8px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.75);
  padding: 4px 14px;
  border-radius: 20px;
  font-size: 12px;
  color: #fff;
  display: none;
  z-index: 5;
}

/* Botones */
.scanner-btn {
  position: absolute;
  bottom: 10px;
  width: 42px;
  height: 42px;
  border-radius: 50%;
  border: none;
  background: rgba(0,0,0,0.8);
  color: #fff;
  box-shadow: 0 0 10px rgba(0,0,0,0.6);
  z-index: 6;
}

.scanner-btn.left {
  left: 10px;
}

.scanner-btn.right {
  right: 10px;
  background: rgba(220,53,69,0.9);
}

/* Animaciones */
@keyframes scan {
  from { top: 0; }
  to { top: 100%; }
}

@keyframes pulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.6; }
  100% { transform: scale(1); opacity: 1; }
}

</style>

<!-- Card principal -->
<div class="card bg-dark text-light border-0 shadow-lg rounded-4">
    <div class="card-body">

        <!-- Área de cámara -->
        <div class="mb-3" style="height:300px;">
<div id="scannerCard"
     class="scanner-shell border border-secondary rounded-4 shadow-lg"
     style="height:300px; position:relative; overflow:hidden; cursor:pointer;">

  <!-- Video -->
  <video id="cameraVideo"
         autoplay
         playsinline
         class="w-100 h-100 d-none"
         style="object-fit:cover;"></video>

  <!-- Overlay oscuro -->
  <div class="scanner-mask"></div>

  <!-- Marco de escaneo -->
  <div id="plateGuide" class="scanner-frame">
    <div class="scan-line"></div>
  </div>

  <!-- Estado superior -->
  <div class="scanner-header">
    <i class="bi bi-car-front-fill me-1"></i>
    <span id="scannerTitle">ParkOps Scanner</span>
  </div>

  <!-- Placeholder -->
  <div id="cameraPlaceholder" class="scanner-placeholder">
    <div class="scanner-icon">
      <i class="bi bi-camera-video-fill"></i>
    </div>
    <div class="scanner-text">
      Toca para escanear placa
    </div>
    <div class="scanner-subtext">
      Coloca la placa dentro del marco
    </div>
  </div>

  <!-- Estado -->
  <div id="scannerStatus" class="scanner-status">
    <span id="statusText">Iniciando cámara...</span>
  </div>

  <!-- Reset -->
  <button id="resetBtn"
          class="scanner-btn left"
          title="Reiniciar">
    <i class="bi bi-arrow-clockwise"></i>
  </button>

  <!-- Stop -->
  <button id="stopBtn"
          class="scanner-btn right"
          title="Detener"
          style="display:none;">
    <i class="bi bi-x-lg"></i>
  </button>
</div>

        </div>

<canvas id="cameraCanvas" class="d-none"></canvas>

        <!-- Input -->
        <form method="POST">
            {% csrf_token %}

            <div class="mb-3">
                <label class="form-label small text-muted">
                    Placa del vehículo
                </label>

                <div class="input-group mb-2">
                    <!-- Icono / Cámara -->
                    <span class="input-group-text bg-dark border border-white text-light rounded-start-3">
                        <i class="bi bi-upc-scan text-light opacity-75"></i>
                    </span>

                    <!-- Campo -->
                    <input type="text"
                           name="plate"
                           id="plateInput"
                           value="{{ form.plate.value|default_if_none:'' }}"
                           class="form-control bg-dark border border-white text-light rounded-end-3"
                           placeholder="Escanear o escribir placa..."
                           style="box-shadow:none;"
                           required>
                </div>

                {% if form.plate.help_text %}
                <div class="form-text text-muted mt-1">
                    {{ form.plate.help_text }}
                </div>
                {% endif %}
            </div>

            <!-- Botón -->
            <button type="submit"
                    class="btn btn-success w-100 rounded-pill shadow-sm">
                <i class="bi bi-upc-scan me-1"></i>
                Escanear placa
            </button>
        </form>
    </div>
</div>

{% endblock %}

{% block menu_bottom %}
    {% include 'parking/partials/_parking_menu_bottom.html' %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {

/* ============================== SYSTEM ============================== */
console.log("[PARKOPS] SYSTEM ready");

/* ============================== DOM ============================== */
const plateInput = document.getElementById("plateInput");
const scannerCard = document.getElementById("scannerCard");
const video = document.getElementById("cameraVideo");
const plateGuide = document.getElementById("plateGuide");
const placeholder = document.getElementById("cameraPlaceholder");
const statusBar = document.getElementById("scannerStatus");
const statusText = document.getElementById("statusText");
const resetBtn = document.getElementById("resetBtn");
const stopBtn = document.getElementById("stopBtn");
const canvas = document.getElementById("cameraCanvas");

if (!scannerCard || !video || !canvas) {
  console.warn("⚠️ Scanner DOM no encontrado");
  return;
}

const ctx = canvas.getContext("2d", { willReadFrequently: true });

/* ============================== CONFIG ============================== */
const OCR_INTERVAL = 350; // ms entre OCR
const MIN_EDGES = 0.12;
const MIN_CONTRAST = 11;
const BUFFER_SIZE = 3;
const MAX_LOGS = 50;
const LEARN_KEY = "parkops_learn";

/* ============================== DEBUG OVERLAY ============================== */
const debugBox = document.createElement("div");
Object.assign(debugBox.style, {
  position: "fixed",
  top: "10px",
  left: "5%",
  width: "90%",
  maxHeight: "45%",
  overflowY: "auto",
  background: "rgba(0,0,0,0.9)",
  color: "#00ff90",
  fontSize: "11px",
  fontFamily: "monospace",
  padding: "8px",
  borderRadius: "10px",
  zIndex: "9999",
  display: "none"
});
document.body.appendChild(debugBox);

let debugEnabled = false;
let lastTap = 0;
let logs = [];

function log(msg) {
  const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
  console.log("[PARKOPS]", msg);
  if (!debugEnabled) return;
  logs.push(line);
  if (logs.length > MAX_LOGS) logs.shift();
  debugBox.textContent = logs.join("\n");
  debugBox.scrollTop = debugBox.scrollHeight;
}

/* ============================== MEMORY MONITOR ============================== */
setInterval(() => {
  if (performance.memory && debugEnabled) {
    const mb = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
    log(`[MEM] ${mb} MB`);
  }
}, 5000);

/* ============================== LEARNING DB ============================== */
let learnDB = JSON.parse(localStorage.getItem(LEARN_KEY) || "{}");

function saveLearn() {
  localStorage.setItem(LEARN_KEY, JSON.stringify(learnDB));
}

function learnAccept(plate) {
  log(`[LEARN] ACCEPT ${plate}`);
  learnDB[plate] = learnDB[plate] || { ok: 0, bad: 0 };
  learnDB[plate].ok++;
  saveLearn();
  resetScanner();
}

function learnReject(plate) {
  log(`[LEARN] REJECT ${plate}`);
  learnDB[plate] = learnDB[plate] || { ok: 0, bad: 0 };
  learnDB[plate].bad++;
  saveLearn();
  resetScanner();
}

/* ============================== STATE ============================== */
let stream = null;
let scanning = false;
let detecting = false;
let goodFrames = 0;
let lastPlate = "";
let buffer = [];
let lastOCRTime = 0;

/* ============================== PLATE FORMAT ============================== */
const plateRegex = /\b(P|M|N|C|A|CD)\s?[0-9]{1,3}\s?[A-Z0-9]?\s?[0-9]{2,3}\b/;

/* ============================== UI ============================== */
function showStatus(text) {
  statusText.textContent = text;
  statusBar.style.display = "block";
}
function hideStatus() { statusBar.style.display = "none"; }
function showInitial() {
  placeholder.style.display = "block";
  video.classList.add("d-none");
  plateGuide.style.display = "none";
  stopBtn.style.display = "none";
  hideStatus();
}
function showScanning() {
  placeholder.style.display = "none";
  video.classList.remove("d-none");
  plateGuide.style.display = "block";
  stopBtn.style.display = "block";
  showStatus("Escaneando placa...");
}

/* ============================== RESULT UI ============================== */
function showDetected(plate) {
  scanning = false;
  stopStream();
  hideStatus();
  plateGuide.style.display = "none";
  stopBtn.style.display = "none";
  video.classList.add("d-none");

  placeholder.innerHTML = `
    <div class="text-success fw-bold mb-1">Placa detectada</div>
    <div class="fs-4">${plate}</div>
    <div class="mt-2 d-flex gap-2 justify-content-center">
      <button id="btnOk" class="btn btn-success btn-sm">✔ Correcto</button>
      <button id="btnBad" class="btn btn-danger btn-sm">✖ Incorrecto</button>
    </div>
  `;
  placeholder.style.display = "block";

  document.getElementById("btnOk").onclick = () => learnAccept(plate);
  document.getElementById("btnBad").onclick = () => learnReject(plate);
}

/* ============================== CAMERA ============================== */
async function startCamera() {
  if (stream) return;
  try {
    showStatus("Iniciando cámara...");
    log("CAMERA start");

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment", width:{ideal:1920}, height:{ideal:1080} },
      audio: false
    });

    video.srcObject = stream;
    await video.play();

    scanning = true;
    detecting = false;
    goodFrames = 0;
    buffer = [];
    lastPlate = "";

    showScanning();
    requestAnimationFrame(scanLoop);
  } catch (e) {
    showStatus("❌ No se pudo abrir cámara");
    console.error(e);
  }
}

function stopStream() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = null;
}

function stopCamera(e) {
  e?.stopPropagation();
  scanning = false;
  stopStream();
  showInitial();
  log("CAMERA stop");
}

/* ============================== RESET ============================== */
function resetScanner(e) {
  e?.stopPropagation();
  if (plateInput) plateInput.value = "";
  placeholder.innerHTML = `
    <i class="bi bi-camera-video-fill fs-1 text-info"></i>
    <div class="small text-muted">Toca para escanear placa</div>
  `;
  stopCamera();
}

/* ============================== FRAME ANALYSIS ============================== */
function analyzeFrame(frame) {
  let edges = 0, contrast = 0, last = 0;
  const d = frame.data;
  for (let i = 0; i < d.length; i+=16){
    const gray = d[i]*0.3 + d[i+1]*0.59 + d[i+2]*0.11;
    contrast += Math.abs(gray - last);
    if(Math.abs(gray - last) > 22) edges++;
    last = gray;
  }
  const px = d.length/16;
  const edgeDensity = edges/px;
  const avgContrast = contrast/px;
  const stable = edgeDensity>MIN_EDGES && avgContrast>MIN_CONTRAST;
  log(`[DETECT] edges=${edgeDensity.toFixed(2)} contrast=${avgContrast.toFixed(1)} stable=${stable}`);
  return stable;
}

/* ============================== BUFFER ============================== */
function pushBuffer(plate){
  buffer.push(plate);
  if(buffer.length>BUFFER_SIZE) buffer.shift();
  const counts = {};
  buffer.forEach(p=>counts[p]=(counts[p]||0)+1);
  for(const p in counts) if(counts[p]>=2) return p;
  return null;
}

/* ============================== OCR ============================== */
async function runOCR(frame, rw, rh){
  log("[OCR] running");

  const tempCanvas = document.createElement("canvas");
  tempCanvas.width = rw; tempCanvas.height = rh;
  tempCanvas.getContext("2d").putImageData(frame,0,0);

  try {
    const result = await Tesseract.recognize(tempCanvas,"eng",{
      tessedit_char_whitelist:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
      psm:6
    });

    let text = result.data.text.toUpperCase().replace(/[^A-Z0-9 ]/g," ").replace(/\s+/g," ").trim();
    log(`[OCR] RAW = "${text}"`);

    const match = text.match(plateRegex);
    if(!match) return;
    let plate = match[0].replace(/\s+/g," ");

    const mem = learnDB[plate];
    let score = 1;
    if(mem){ score += mem.ok*0.5; score -= mem.bad; log(`[LEARN] mem ok=${mem.ok} bad=${mem.bad}`);}
    if(score<1){ log(`[OCR] REJECTED by score ${score.toFixed(2)}`); return; }

    const confirmed = pushBuffer(plate);
    if(confirmed && confirmed!==lastPlate){
      lastPlate = confirmed;
      plateInput.value = confirmed;
      navigator.vibrate?.([100,50,100]);
      log(`[OCR] MATCH = "${confirmed}"`);
      showDetected(confirmed);
    }

  } catch(e){ console.warn("OCR error", e);}
}

/* ============================== SCAN LOOP (MEJORADO) ============================== */
async function scanLoop(){
  if(!scanning || detecting) return;
  if(!video.videoWidth){ requestAnimationFrame(scanLoop); return; }
  const now = Date.now();
  if(now-lastOCRTime<OCR_INTERVAL){ requestAnimationFrame(scanLoop); return; }
  lastOCRTime=now;
  detecting=true;

  const scale=0.6;
  const w=video.videoWidth*scale;
  const h=video.videoHeight*scale;
  canvas.width=w; canvas.height=h;
  ctx.drawImage(video,0,0,w,h);

  const rx=w*0.2, ry=h*0.4, rw=w*0.6, rh=h*0.22;
  const rawFrame=ctx.getImageData(rx,ry,rw,rh);
  let ocrFrame=ctx.getImageData(rx,ry,rw,rh);

  // ==== PREPROCESAMIENTO PARA LUZ INTENSA ====
  const d=ocrFrame.data;
  let sum=0;
  for(let i=0;i<d.length;i+=4){ sum+=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; }
  const avg=sum/(d.length/4);
  const factor=128/(avg+1);
  for(let i=0;i<d.length;i+=4){
    let gray=(0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]-avg)*factor+128;
    gray=Math.max(0,Math.min(255,gray));
    d[i]=d[i+1]=d[i+2]=gray;
  }
  // Binarización adaptativa simple
  const localAvg=sum/(d.length/4);
  for(let i=0;i<d.length;i+=4){ d[i]=d[i+1]=d[i+2]=d[i]>localAvg*0.95?255:0; }

  const good=analyzeFrame(rawFrame);
  if(good){
    goodFrames++;
    log(`[DETECT] good frame (${goodFrames}/2)`);
    if(goodFrames>=2){ await runOCR(ocrFrame,rw,rh); goodFrames=0; }
  } else goodFrames=Math.max(0,goodFrames-1);

  detecting=false;
  requestAnimationFrame(scanLoop);
}

/* ============================== EVENTS ============================== */
scannerCard.addEventListener("click",()=>{ if(!stream) startCamera(); });
scannerCard.addEventListener("touchend",()=>{
  const now=Date.now();
  if(now-lastTap<350){
    debugEnabled=!debugEnabled;
    debugBox.style.display=debugEnabled?"block":"none";
    log("DEBUG "+(debugEnabled?"ON":"OFF"));
  }
  lastTap=now;
});
stopBtn.addEventListener("click",stopCamera);
resetBtn.addEventListener("click",resetScanner);

/* ============================== INIT ============================== */
showInitial();

});
</script>




{% endblock %}
