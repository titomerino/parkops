{% extends "shell/base.html" %}

{% block title %}ParkOps / Escanear placa de vehículo{% endblock %}
{% block page_title %}Parking / escanear{% endblock %}

{% block content %}

{% include 'shell/partials/_messages_alert.html' with messages=messages %}

<!-- Card principal -->
<div class="card bg-dark text-light border-0 shadow-lg rounded-4">
    <div class="card-body">

        <!-- Área de cámara -->
        <div class="mb-3" style="height:300px;">
<!-- Área cámara -->
<div id="scannerCard" class="bg-dark border border-secondary rounded-4 shadow-lg p-2"
     style="height:300px; position:relative; overflow:hidden; cursor:pointer;">

    <!-- Video -->
    <video id="cameraVideo"
           autoplay
           playsinline
           class="w-100 h-100 d-none rounded-4"
           style="object-fit:cover;"></video>

    <!-- Guía placa -->
    <div id="plateGuide"
         class="position-absolute rounded"
         style="border:2px dashed #0d6efd; width:60%; height:22%; top:39%; left:20%; display:none; pointer-events:none;">
    </div>

    <!-- Placeholder -->
    <div id="cameraPlaceholder"
         class="position-absolute bottom-0 w-100 text-center pb-3">
        <i class="bi bi-camera-video-fill fs-1 text-info"></i>
        <div class="small text-muted">Toca para escanear placa</div>
    </div>

    <!-- Estado -->
    <div id="scannerStatus"
         class="position-absolute bottom-0 w-100 text-center py-1"
         style="background:rgba(0,0,0,.6); display:none;">
        <span class="small text-light" id="statusText">Iniciando cámara...</span>
    </div>

    <!-- Reset -->
    <button id="resetBtn"
            class="btn btn-warning btn-sm position-absolute bottom-0 start-0 m-2 rounded-circle shadow"
            style="width:42px; height:42px;">
        <i class="bi bi-arrow-clockwise"></i>
    </button>

    <!-- Stop -->
    <button id="stopBtn"
            class="btn btn-danger btn-sm position-absolute bottom-0 end-0 m-2 rounded-circle shadow"
            style="width:42px; height:42px; display:none;">
        <i class="bi bi-x-lg"></i>
    </button>

</div>

</div>

<canvas id="cameraCanvas" class="d-none"></canvas>

        <!-- Input -->
        <form method="POST">
            {% csrf_token %}

            <div class="mb-3">
                <label class="form-label small text-muted">
                    Placa del vehículo
                </label>

                <div class="input-group mb-2">
                    <!-- Icono / Cámara -->
                    <span class="input-group-text bg-dark border border-white text-light rounded-start-3">
                        <i class="bi bi-upc-scan text-light opacity-75"></i>
                    </span>

                    <!-- Campo -->
                    <input type="text"
                           name="plate"
                           id="plateInput"
                           value="{{ form.plate.value|default_if_none:'' }}"
                           class="form-control bg-dark border border-white text-light rounded-end-3"
                           placeholder="Escanear o escribir placa..."
                           style="box-shadow:none;"
                           required>
                </div>

                {% if form.plate.help_text %}
                <div class="form-text text-muted mt-1">
                    {{ form.plate.help_text }}
                </div>
                {% endif %}
            </div>

            <!-- Botón -->
            <button type="submit"
                    class="btn btn-success w-100 rounded-pill shadow-sm">
                <i class="bi bi-upc-scan me-1"></i>
                Escanear placa
            </button>
        </form>
    </div>
</div>

{% endblock %}

{% block menu_bottom %}
    {% include 'parking/partials/_parking_menu_bottom.html' %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {

// ---------------- DOM ----------------
const plateInput = document.getElementById("plateInput");
const scannerCard = document.getElementById("scannerCard");
const video = document.getElementById("cameraVideo");
const plateGuide = document.getElementById("plateGuide");
const placeholder = document.getElementById("cameraPlaceholder");
const statusBar = document.getElementById("scannerStatus");
const statusText = document.getElementById("statusText");
const resetBtn = document.getElementById("resetBtn");
const stopBtn = document.getElementById("stopBtn");
const canvas = document.getElementById("cameraCanvas");

if (!scannerCard || !video || !canvas) {
  console.warn("⚠️ Scanner DOM no encontrado");
  return;
}

const ctx = canvas.getContext("2d");

// ---------------- STATE ----------------
let stream = null;
let scanning = false;
let detecting = false;
let lastPlate = "";
let lastLog = 0;
let lastOCR = 0;
const plateBuffer = [];

// ---------------- FORMATO PLACAS ----------------
// P123 122 | P 123 122 | M123123 | M123 123 | P 12 8F2
// A123 123 | A 123 123 | P 123-456 | CD 12-345 | etc
const plateRegex = /\b(P|M|N|C|A|CD)\s?[0-9]{1,3}\s?[A-Z0-9]?\s?[- ]?[0-9]{2,3}\b/;

// ---------------- DEBUG OVERLAY (DOBLE TAP) ----------------
const debugBox = document.createElement("div");
debugBox.style.position = "fixed";
debugBox.style.top = "10px";
debugBox.style.left = "5%";
debugBox.style.width = "90%";
debugBox.style.maxHeight = "45%";
debugBox.style.overflowY = "auto";
debugBox.style.background = "rgba(0,0,0,0.85)";
debugBox.style.color = "#00ff90";
debugBox.style.fontSize = "11px";
debugBox.style.fontFamily = "monospace";
debugBox.style.padding = "8px";
debugBox.style.borderRadius = "10px";
debugBox.style.zIndex = "9999";
debugBox.style.display = "none";
debugBox.style.boxShadow = "0 0 10px rgba(0,0,0,0.7)";
document.body.appendChild(debugBox);

let debugEnabled = false;
let lastTap = 0;

// ---------------- LOG ----------------
function log(msg) {
  const now = performance.now();
  if (now - lastLog < 120) return;
  lastLog = now;

  const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
  console.log(`[PARKOPS] ${msg}`);

  if (debugEnabled) {
    const div = document.createElement("div");
    div.textContent = line;
    debugBox.appendChild(div);
    while (debugBox.children.length > 30) {
      debugBox.removeChild(debugBox.firstChild);
    }
    debugBox.scrollTop = debugBox.scrollHeight;
  }
}

// ---------------- NORMALIZACIÓN OCR ----------------
function normalizePlate(text) {
  return text
    .replace(/O/g, "0")
    .replace(/I/g, "1")
    .replace(/Z/g, "2")
    .replace(/S/g, "5")
    .replace(/B/g, "8");
}

// ---------------- UI ----------------
function showStatus(text) {
  statusText.textContent = text;
  statusBar.style.display = "block";
}

function hideStatus() {
  statusBar.style.display = "none";
}

function showInitial() {
  placeholder.style.display = "block";
  video.classList.add("d-none");
  plateGuide.style.display = "none";
  stopBtn.style.display = "none";
  hideStatus();
}

function showScanning() {
  placeholder.style.display = "none";
  video.classList.remove("d-none");
  plateGuide.style.display = "block";
  stopBtn.style.display = "block";
  showStatus("Escaneando placa...");
}

function showDetected(plate) {
  scanning = false;
  stopStream();

  hideStatus();
  plateGuide.style.display = "none";
  stopBtn.style.display = "none";
  video.classList.add("d-none");

  placeholder.innerHTML = `
    <i class="bi bi-check-circle-fill fs-1 text-success"></i>
    <div class="fw-bold text-success">Placa detectada</div>
    <div class="small text-light mt-1">${plate}</div>
  `;
  placeholder.style.display = "block";
}

// ---------------- CÁMARA ----------------
async function startCamera() {
  if (stream) return;

  try {
    showStatus("Iniciando cámara...");
    log("SYSTEM ready");
    log("CAMERA start");

    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: "environment",
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      },
      audio: false
    });

    video.srcObject = stream;
    await video.play();

    scanning = true;
    detecting = false;
    lastOCR = 0;
    plateBuffer.length = 0;

    showScanning();
    requestAnimationFrame(scanLoop);
  } catch (err) {
    showStatus("❌ No se pudo acceder a la cámara");
    console.error(err);
  }
}

function stopStream() {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
}

function stopCamera(e) {
  e?.stopPropagation();
  scanning = false;
  stopStream();
  showInitial();
  log("CAMERA stop");
}

// ---------------- RESET ----------------
function resetScanner(e) {
  e?.stopPropagation();
  if (plateInput) plateInput.value = "";

  placeholder.innerHTML = `
    <i class="bi bi-camera-video-fill fs-1 text-info"></i>
    <div class="small text-muted">Toca para escanear placa</div>
  `;

  stopCamera();
}

// ---------------- ANALISIS FRAME ----------------
function analyzeFrame(frame) {
  let edges = 0;
  let contrast = 0;
  let last = 0;

  const d = frame.data;

  for (let i = 0; i < d.length; i += 20) {
    const gray = d[i] * 0.3 + d[i+1] * 0.59 + d[i+2] * 0.11;
    contrast += Math.abs(gray - last);
    if (Math.abs(gray - last) > 20) edges++;
    last = gray;
  }

  const px = d.length / 20;
  const edgeDensity = edges / px;
  const avgContrast = contrast / px;

  // Umbral afinado para parqueo real
  const stable = edgeDensity > 0.06 && avgContrast > 9;

  log(`[DETECT] edges=${edgeDensity.toFixed(2)} contrast=${avgContrast.toFixed(1)} stable=${stable}`);

  return stable;
}

// ---------------- OCR ----------------
async function runOCR(ocrFrame, rw, rh) {
  log("[OCR] running");

  const tempCanvas = document.createElement("canvas");
  tempCanvas.width = rw;
  tempCanvas.height = rh;
  tempCanvas.getContext("2d").putImageData(ocrFrame, 0, 0);

  try {
    const result = await Tesseract.recognize(tempCanvas, "eng", {
      tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
      psm: 6
    });

    let text = result.data.text
      .toUpperCase()
      .replace(/[^A-Z0-9 ]/g, " ")
      .replace(/\s+/g, " ")
      .trim();

    text = normalizePlate(text);

    log(`[OCR] RAW = "${text}"`);

    let match = text.match(plateRegex);

    // Si solo detecta números → forzar prefijo P
    if (!match && /^[0-9]{3}\s?[0-9]{3}$/.test(text)) {
      text = "P " + text;
      match = text.match(plateRegex);
      log(`[OCR] FORCED PREFIX = "${text}"`);
    }

    if (match) {
      const plate = match[0].replace(/\s+/g, " ");

      // -------- BUFFER DE CONFIRMACIÓN --------
      plateBuffer.push(plate);
      if (plateBuffer.length > 3) plateBuffer.shift();

      const hits = plateBuffer.filter(p => p === plate).length;
      log(`[OCR] BUFFER = ${plateBuffer.join(" | ")} (${hits}/3)`);

      if (hits >= 2 && plate !== lastPlate) {
        lastPlate = plate;
        plateInput.value = plate;
        navigator.vibrate?.([100, 50, 100]);
        showDetected(plate);
        log(`[OCR] CONFIRMED = ${plate}`);
      }
      return true;
    }

  } catch (e) {
    console.warn("OCR error", e);
  }

  return false;
}

// ---------------- LOOP PRINCIPAL ----------------
async function scanLoop() {
  if (!scanning || detecting) return;

  if (!video.videoWidth) {
    requestAnimationFrame(scanLoop);
    return;
  }

  detecting = true;

  const scale = 0.6;
  const w = video.videoWidth * scale;
  const h = video.videoHeight * scale;

  canvas.width = w;
  canvas.height = h;
  ctx.drawImage(video, 0, 0, w, h);

  // Región placa (centrada)
  const rx = w * 0.2;
  const ry = h * 0.4;
  const rw = w * 0.6;
  const rh = h * 0.22;

  const rawFrame = ctx.getImageData(rx, ry, rw, rh);
  const ocrFrame = ctx.getImageData(rx, ry, rw, rh);

  // Binarización SOLO para OCR
  for (let i = 0; i < ocrFrame.data.length; i += 4) {
    const r = ocrFrame.data[i];
    const g = ocrFrame.data[i+1];
    const b = ocrFrame.data[i+2];
    let gray = (0.299*r + 0.587*g + 0.114*b);
    gray = gray > 140 ? 255 : 0;
    ocrFrame.data[i] = gray;
    ocrFrame.data[i+1] = gray;
    ocrFrame.data[i+2] = gray;
  }

  const now = performance.now();
  const good = analyzeFrame(rawFrame);

  // OCR solo cada 350ms si la imagen está estable
  if (good && now - lastOCR > 350) {
    lastOCR = now;
    await runOCR(ocrFrame, rw, rh);
  }

  detecting = false;
  requestAnimationFrame(scanLoop);
}

// ---------------- EVENTOS ----------------
scannerCard.addEventListener("click", () => {
  if (!stream) startCamera();
});

// DOBLE TAP = LOGS
scannerCard.addEventListener("touchend", () => {
  const now = Date.now();
  if (now - lastTap < 350) {
    debugEnabled = !debugEnabled;
    debugBox.style.display = debugEnabled ? "block" : "none";
    console.log("[PARKOPS] DEBUG " + (debugEnabled ? "ON" : "OFF"));
  }
  lastTap = now;
});

stopBtn.addEventListener("click", stopCamera);
resetBtn.addEventListener("click", resetScanner);

// INIT
showInitial();

});
</script>

{% endblock %}
